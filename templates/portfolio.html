{% extends "base.html" %}
{% load static %}

{% block extra_head %}{{ block.super }}
<link rel="stylesheet" href="{% static 'css/magnific-popup.min.css' %}">
{% endblock %}

{% block title %}Portfolio | HMD Klusbedrijf{% endblock %}

{% block content %}
<div class="mt-bnr-inr overlay-wraper bg-parallax bg-top-center" data-stellar-background-ratio="0.5"
    style="background-image:url('{% static 'img/background/banner-default.jpg' %}')">
    <div class="overlay-main bg-black opacity-07"></div>
    <div class="container">
        <div class="mt-bnr-inr-entry">
            <div class="banner-title-outer">
                <div class="banner-title-name">
                    <h2 class="m-b0">Portfolio</h2>
                </div>
            </div>
            <div>
                <ul class="mt-breadcrumb breadcrumb-style-2">
                    <li><a href="{% url 'index' %}">Home</a></li>
                    <li>Portfolio</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="section-full p-tb80 bg-gray inner-page-padding">
    <div class="container-fluid">

        <div class="filter-wrap p-b30 text-center">
            <ul id="portfolioFilters"
                class="filter-navigation inline-navigation masonry-filter link-style text-uppercase">
                <li class="active"><a href="#" data-filter="*">All</a></li>
                <li><a href="#" data-filter=".cat-keuken">Keuken</a></li>
                <li><a href="#" data-filter=".cat-badkamer">Badkamer</a></li>
                <li><a href="#" data-filter=".cat-vloeren">Vloeren</a></li>
                <li><a href="#" data-filter=".cat-klus-en-reparatiewerk">Klus en Reparatiewerk</a></li>
                <li><a href="#" data-filter=".cat-stukwerk">Stukwerk</a></li>
            </ul>

            {% if request.GET.preview %}
            <a href="#" class="site-button m-l10 js-admin-form" data-admin-formurl="/admin/core/portfolioitem/add/">
                Insert new
            </a>
            {% endif %}
        </div>

        <div class="portfolio-wrap mfp-gallery work-grid row clearfix">
            <div class="portfolio-columns">
            {% for item in items %}
            <div class="masonry-item cat-{{ item.category_slug }} col-xl-3 col-lg-4 col-md-6 col-sm-6 m-b30">
                <div class="image-effect-one hover-shadow">
                    {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.title|default:'Projectfoto' }}">
                    <a class="mfp-link" href="{{ item.image.url }}"><i class="fa fa-arrows-alt"
                            aria-hidden="true"></i></a>
                    {% else %}
                    <img src="{% static 'img/placeholder-portfolio.jpg' %}"
                        alt="{{ item.title|default:'Projectfoto' }}">
                    {% endif %}

                    <div class="figcaption">
                        <a class="mfp-link" href="{{ item.image.url }}"><i class="fa fa-search-plus"
                                aria-hidden="true"></i></a>
                    </div>

                    <div class="portfolio-title-bar">
                        <h6 style="margin:0;font-weight:600;font-size:14px;">
                            {% firstof item.title item.caption item.name "Untitled item" %}
                        </h6>
                    </div>

                    {% if request.GET.preview %}
                    <a href="#" class="admin-edit-btn js-admin-form"
                        data-admin-formurl="/admin/core/portfolioitem/{{ item.id }}/change/" title="Edit item"
                        style="position:absolute;left:12px;top:12px;z-index:7;display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:16px;background:#2b6cb0;color:#fff;font-size:12px;text-decoration:none;">
                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                            <path
                                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" />
                        </svg>
                        Edit
                    </a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center p-b30">Nog geen portfolio-items.</div>
            {% endfor %}

            {% if request.GET.preview %}
            <div class="masonry-item col-xl-3 col-lg-4 col-md-6 col-sm-6 m-b30">
                <a href="#" class="image-effect-one hover-shadow add-card js-admin-form"
                    data-admin-formurl="/admin/core/portfolioitem/add/">
                    <span class="add-plus">+</span><span class="add-label">Insert new</span>
                </a>
            </div>
            {% endif %}
            </div>
        </div>

    </div>
</div>

<script>
    function relayoutPortfolio() {
        if (!window.jQuery) return;
        const $wrap = jQuery('.portfolio-wrap');
        if (!$wrap.length) return;
        if (jQuery.fn.isotope) {
            $wrap.isotope('layout');
        } else if (jQuery.fn.masonry) {
            $wrap.masonry('layout');
        }
    }

    window.addEventListener('load', function () {
        relayoutPortfolio();
        setTimeout(relayoutPortfolio, 400);
    });

    window.addEventListener('resize', function () {
        relayoutPortfolio();
    });
</script>
{% block extra_js %}{{ block.super }}
<script>
(function () {
  function ready(fn){ if(document.readyState!=="loading"){ fn(); } else { document.addEventListener("DOMContentLoaded", fn); } }

  ready(function () {
    const ul = document.getElementById("portfolioFilters");
    const wrap = document.querySelector(".portfolio-wrap");
    if (!ul || !wrap) return;

    ul.addEventListener("click", function (e) {
      const a = e.target.closest("a[data-filter]");
      if (!a) return;

      e.preventDefault();
      const isPreview = !!window.__EDITOR_PREVIEW__;
      if (isPreview) {
        e.stopPropagation();
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
      }

      ul.querySelectorAll("li").forEach(li => li.classList.remove("active"));
      if (a.parentElement) a.parentElement.classList.add("active");

      const sel = a.getAttribute("data-filter") || "*";

      const hasIso = !!(window.jQuery && jQuery.fn && jQuery.fn.isotope);
      const $wrap = hasIso ? jQuery(wrap) : null;
      const isoInstance = ($wrap && $wrap.data) ? $wrap.data("isotope") : null;

      if (isPreview || !hasIso || !isoInstance) {
        wrap.querySelectorAll(".masonry-item").forEach(card => {
          const show = (sel === "*") || card.matches(sel);
          card.style.display = show ? "" : "none";
        });
        return;
      }

      $wrap.isotope({ filter: sel });
      $wrap.isotope("layout");
    });
  });
})();

// Preview-only: stop href="#" from jumping to top
if (window.__EDITOR_PREVIEW__) {
  document.addEventListener("click", function (e) {
    const a = e.target.closest('a[href="#"]');
    if (!a) return;
    e.preventDefault();
  }, true);
  const _reload = window.location.reload;
  window.location.reload = function () {
    window.parent.postMessage({ type: "EDITOR_PREVIEW_RELOAD" }, "*");
    return _reload.apply(window.location, arguments);
  };
}

async function openAdminForm(url) {
  const html = await fetch(url, { credentials: "include" }).then(r => r.text());
  const doc = new DOMParser().parseFromString(html, "text/html");

  const forms = Array.from(doc.querySelectorAll("form"));
  let form = forms
    .filter(f => f.querySelector('input[name="csrfmiddlewaretoken"]'))
    .filter(f => !/changelist-search/i.test(f.id || ""))
    .sort((a, b) => (b.querySelectorAll("input,select,textarea").length) -
      (a.querySelectorAll("input,select,textarea").length))[0];

  if (!form) { window.location.href = url; return; }

  const shell = document.createElement("div");
  shell.className = "ap-modal";
  const title = (doc.querySelector("#content h1") || {}).textContent || "Edit";
  shell.innerHTML = '<div class="ap-header">' + title + '</div><div class="ap-body"></div>';
  shell.querySelector(".ap-body").appendChild(form);

  form.addEventListener("submit", async function (ev) {
    ev.preventDefault();
    const fd = new FormData(form);
    const resp = await fetch(form.action, {
      method: "POST", body: fd, credentials: "include", redirect: "follow"
    });
    if (resp.redirected) {
      window.parent.postMessage({ type: "EDITOR_PREVIEW_RELOAD" }, "*");
      window.location.reload();
      return;
    }
    const txt = await resp.text();
    const doc2 = new DOMParser().parseFromString(txt, "text/html");
    const forms2 = Array.from(doc2.querySelectorAll("form"))
      .filter(f => f.querySelector('input[name="csrfmiddlewaretoken"]'))
      .filter(f => !/changelist-search/i.test(f.id || ""))
      .sort((a, b) => (b.querySelectorAll("input,select,textarea").length) -
        (a.querySelectorAll("input,select,textarea").length));
    const form2 = forms2[0];
    if (!form2) { window.location.reload(); return; }
    shell.querySelector(".ap-body").innerHTML = "";
    shell.querySelector(".ap-body").appendChild(form2);
  });

  if (window.jQuery && jQuery.magnificPopup) {
    jQuery.magnificPopup.open({ items: { src: shell }, type: "inline" });
  } else {
    document.body.innerHTML = ""; document.body.appendChild(shell);
  }
}

document.addEventListener("click", function (e) {
  const a = e.target.closest("a.js-admin-form[data-admin-formurl]");
  if (!a) return;
  e.preventDefault();
  openAdminForm(a.getAttribute("data-admin-formurl"));
});

</script>


{% endblock %}

{% endblock %}
