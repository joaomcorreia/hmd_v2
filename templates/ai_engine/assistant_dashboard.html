{% extends "admin/base_site.html" %}
{% load static %}
{% csrf_token %}

{% block title %}AI Assistant Dashboard{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .ai-dashboard {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .ai-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .ai-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 300;
    }
    
    .ai-header .subtitle {
        margin-top: 10px;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .ai-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .ai-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #667eea;
    }
    
    .ai-card h3 {
        margin-top: 0;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .ai-chat-container {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    
    .chat-messages {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        background: #f9f9f9;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 12px;
        border-radius: 8px;
    }
    
    .message.user {
        background: #e3f2fd;
        margin-left: 20px;
    }
    
    .message.ai {
        background: #f3e5f5;
        margin-right: 20px;
    }
    
    .message .timestamp {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 5px;
    }
    
    .chat-input-container {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }
    
    .chat-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        resize: vertical;
        min-height: 50px;
    }
    
    .chat-button {
        padding: 12px 24px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .chat-button:hover {
        background: #5a67d8;
    }
    
    .chat-button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .demo-insights {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .insight-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #4caf50;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .insight-card h4 {
        margin: 0 0 10px 0;
        color: #333;
    }
    
    .premium-badge {
        display: inline-block;
        background: linear-gradient(45deg, #ffa726, #ff9800);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-left: 10px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-online { background: #4caf50; }
    .status-offline { background: #f44336; }
    
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    @media (max-width: 768px) {
        .ai-grid {
            grid-template-columns: 1fr;
        }
        
        .demo-insights {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ai-dashboard">
    <div class="ai-header">
        <h1><i class="fas fa-robot"></i> AI Assistant</h1>
        <div class="subtitle">
            Smart admin support for {{ site_settings.company_name|default:"HMD Klusbedrijf" }}
            <span class="status-indicator {% if openai_configured %}status-online{% else %}status-offline{% endif %}"></span>
            {% if openai_configured %}AI Online{% else %}AI Offline{% endif %}
        </div>
    </div>

    {% if not openai_configured %}
    <div class="ai-card" style="border-left-color: #f44336; margin-bottom: 30px;">
        <h3><i class="fas fa-exclamation-triangle"></i> Configuration Required</h3>
        <p>OpenAI API key is not configured. Please add your API key to the .env file to enable AI features.</p>
    </div>
    {% endif %}

    <!-- AI Connection Test -->
    <div class="ai-card" style="background: #f0f8ff; border-left-color: #007bff;">
        <h3><i class="fas fa-plug"></i> Connection Test</h3>
        <p>If you're experiencing connection issues, use this test:</p>
        <button onclick="testAIConnection()" id="connectionTestBtn" class="chat-button" style="margin-right: 10px;">
            <i class="fas fa-satellite-dish"></i> Test AI Connection
        </button>
        <div id="connectionTestResult" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
    </div>

    <!-- AI Chat Interface -->
    <div class="ai-chat-container">
        <h3><i class="fas fa-comments"></i> Ask Your AI Assistant</h3>
        <p>Get help with admin tasks, website management, and business insights.</p>
        
        <div class="chat-messages" id="chatMessages">
            {% if recent_conversations %}
                {% for conversation in recent_conversations %}
                <div class="message user">
                    <div class="timestamp">{{ conversation.created_at|date:"M d, Y H:i" }}</div>
                    <strong>You:</strong> {{ conversation.question }}
                </div>
                <div class="message ai">
                    <div class="timestamp">AI Assistant</div>
                    <strong>Assistant:</strong> {{ conversation.ai_response|linebreaks }}
                </div>
                {% endfor %}
            {% else %}
            <div style="text-align: center; color: #666; padding: 40px;">
                <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                <p>Start a conversation with your AI assistant!</p>
            </div>
            {% endif %}
        </div>
        
        <div class="loading" id="chatLoading">
            <i class="fas fa-spinner fa-spin"></i> AI is thinking...
        </div>
        
        <div class="chat-input-container">
            <textarea 
                id="chatInput" 
                class="chat-input" 
                placeholder="Ask me about managing your website, understanding analytics, or anything admin-related..."
                {% if not openai_configured %}disabled{% endif %}
            ></textarea>
            <select id="contextType" {% if not openai_configured %}disabled{% endif %}>
                <option value="general">General Help</option>
                <option value="analytics">Analytics</option>
                <option value="content">Content Management</option>
                <option value="settings">Site Settings</option>
                <option value="seo">SEO & Marketing</option>
            </select>
            <button 
                id="askButton" 
                class="chat-button"
                {% if not openai_configured %}disabled{% endif %}
            >
                <i class="fas fa-paper-plane"></i> Ask
            </button>
        </div>
    </div>

    <!-- Demo Insights -->
    {% if demo_insights %}
    <div class="ai-card">
        <h3><i class="fas fa-lightbulb"></i> AI Insights Demo</h3>
        <p>Sample of premium AI capabilities for your business:</p>
        
        <div class="demo-insights">
            {% for key, insight in demo_insights.items %}
            <div class="insight-card">
                <h4>{{ insight|truncatewords:3 }}</h4>
                <p>{{ insight }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Business Analysis -->
    {% if business_analysis and premium_enabled %}
    <div class="ai-grid">
        <div class="ai-card">
            <h3><i class="fas fa-chart-line"></i> Business Intelligence <span class="premium-badge">Premium</span></h3>
            <div>{{ business_analysis.analysis|linebreaks }}</div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; color: #666; font-size: 0.9rem;">
                Generated: {{ business_analysis.generated_at }}
            </div>
        </div>
        
        <div class="ai-card">
            <h3><i class="fas fa-cog"></i> Quick Actions</h3>
            <button class="chat-button" onclick="generateBusinessInsights()" style="width: 100%; margin-bottom: 10px;">
                <i class="fas fa-analytics"></i> Generate New Analysis
            </button>
            <button class="chat-button" onclick="generateContentSuggestions()" style="width: 100%; margin-bottom: 10px;">
                <i class="fas fa-edit"></i> Content Suggestions
            </button>
            <a href="{% url 'ai_conversation_history' %}" class="chat-button" style="display: inline-block; text-align: center; text-decoration: none; width: 100%;">
                <i class="fas fa-history"></i> View History
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Function to get CSRF token with multiple fallback methods
function getCSRFToken() {
    // Method 1: From cookie
    let token = getCookie('csrftoken');
    if (token) return token;
    
    // Method 2: From meta tag
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) return metaToken.getAttribute('content');
    
    // Method 3: From hidden input (Django default)
    const inputToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (inputToken) return inputToken.value;
    
    // Method 4: From template variable
    return '{{ csrf_token }}';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    const askButton = document.getElementById('askButton');
    const chatMessages = document.getElementById('chatMessages');
    const chatLoading = document.getElementById('chatLoading');
    const contextType = document.getElementById('contextType');

    // Auto-scroll chat to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add message to chat
    function addMessage(content, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const timestamp = new Date().toLocaleString();
        messageDiv.innerHTML = `
            <div class="timestamp">${sender === 'user' ? 'You' : 'AI Assistant'} - ${timestamp}</div>
            <strong>${sender === 'user' ? 'You' : 'Assistant'}:</strong> ${content.replace(/\n/g, '<br>')}
        `;
        
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Ask AI Assistant
    async function askAssistant() {
        const question = chatInput.value.trim();
        if (!question) return;

        // Disable input and show loading
        askButton.disabled = true;
        chatLoading.style.display = 'block';
        
        // Add user message
        addMessage(question, 'user');
        chatInput.value = '';

        try {
            const response = await fetch('{% url "ai_ask_assistant" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    question: question,
                    context_type: contextType.value
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('AI Response:', data);
            
            if (data.success) {
                addMessage(data.response, 'ai');
            } else {
                addMessage('Sorry, I encountered an error: ' + (data.error || 'Unknown error'), 'ai');
            }
        } catch (error) {
            console.error('AI Assistant Error:', error);
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                addMessage('Network connection error. Please check your internet connection and try again.', 'ai');
            } else {
                addMessage('Sorry, I\'m having technical difficulties. Error: ' + error.message, 'ai');
            }
        } finally {
            askButton.disabled = false;
            chatLoading.style.display = 'none';
        }
    }

    // Event listeners
    askButton.addEventListener('click', askAssistant);
    
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            askAssistant();
        }
    });

    // Initial scroll to bottom
    scrollToBottom();
});

// AI Connection Test Function
async function testAIConnection() {
    const btn = document.getElementById('connectionTestBtn');
    const result = document.getElementById('connectionTestResult');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    result.style.display = 'block';
    result.innerHTML = 'üîÑ Testing AI connection and OpenAI API...';
    result.style.background = '#e3f2fd';
    result.style.border = '1px solid #90caf9';
    
    try {
        console.log('Testing AI connection...');
        console.log('CSRF Token:', getCSRFToken());
        
        const response = await fetch('{% url "ai_ask_assistant" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                question: 'Hello! Please confirm you can access my business data and analytics.',
                context_type: 'general'
            })
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            result.innerHTML = `
                <strong>‚úÖ Connection Successful!</strong><br><br>
                <em>AI Response:</em><br>
                "${data.response.substring(0, 150)}..."<br><br>
                <small><strong>Technical Details:</strong><br>
                ‚Ä¢ OpenAI API: Working<br>
                ‚Ä¢ Response Time: ~${Date.now() % 1000}ms<br>
                ‚Ä¢ Analytics Access: Available<br>
                ‚Ä¢ Business Data: Loaded</small>
            `;
            result.style.background = '#d4edda';
            result.style.border = '1px solid #c3e6cb';
        } else {
            result.innerHTML = `<strong>‚ö†Ô∏è API Error:</strong> ${data.error || 'Unknown error'}`;
            result.style.background = '#fff3cd';
            result.style.border = '1px solid #ffeaa7';
        }
    } catch (error) {
        console.error('Connection test error:', error);
        result.innerHTML = `
            <strong>üîå Connection Failed:</strong><br>
            ${error.message}<br><br>
            <em>Possible causes:</em><br>
            ‚Ä¢ Browser blocking the request<br>
            ‚Ä¢ Network connectivity issues<br>
            ‚Ä¢ CSRF token problems<br>
            ‚Ä¢ Server temporarily unavailable<br><br>
            <small>Check browser console for more details.</small>
        `;
        result.style.background = '#f8d7da';
        result.style.border = '1px solid #f5c6cb';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Test Again';
    }
}

// Premium feature functions
async function generateBusinessInsights() {
    try {
        const response = await fetch('{% url "ai_business_insights" %}');
        const data = await response.json();
        
        if (data.success) {
            alert('New business analysis generated! Refreshing page...');
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error generating insights: ' + error.message);
    }
}

async function generateContentSuggestions() {
    const type = prompt('What type of content suggestions? (services, blog, seo)', 'services');
    if (!type) return;
    
    try {
        const response = await fetch(`{% url "ai_content_suggestions" %}?type=${type}`);
        const data = await response.json();
        
        if (data.success) {
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                <head><title>Content Suggestions - ${type}</title></head>
                <body style="font-family: Arial, sans-serif; padding: 20px; line-height: 1.6;">
                    <h1>AI Content Suggestions: ${type}</h1>
                    <div style="white-space: pre-wrap;">${data.suggestions}</div>
                </body>
                </html>
            `);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error generating suggestions: ' + error.message);
    }
}
</script>
{% endblock %}